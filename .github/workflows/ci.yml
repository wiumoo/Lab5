name: C++ Qt Project CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1) 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) 安装 Qt（使用 Ubuntu APT + Qt5：更稳，避免 Qt6 在 runner 上出现符号不匹配/链接失败）
      # 说明：本项目未依赖 Qt6-only API；Qt5 能满足 QtTest + QtSql(QSQLITE)。
      - name: Install build tools & Qt
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential make gcovr \
            gcc-12 g++-12 \
            qtbase5-dev qtbase5-dev-tools qt5-qmake qtchooser \
            qttools5-dev-tools \
            libqt5sql5-sqlite \
            libgl1-mesa-dev

      # 3) 构建并运行单元测试（QtTest）
      - name: Build & run QtTest
        working-directory: Lab4/project/tests
        run: |
          mkdir -p build
          cd build
          export QT_SELECT=qt5
          echo "Using qmake: $(command -v qmake)"
          qmake "CONFIG+=coverage" "QMAKE_CC=gcc-12" "QMAKE_CXX=g++-12" ../LedgerAppTests.pro
          make -j2
          QT_QPA_PLATFORM=offscreen ./LedgerAppTests -maxwarnings 0

      # 4) 生成覆盖率报告（基于 gcov）
      - name: Coverage (gcovr)
        working-directory: Lab4/project/tests
        run: |
          cd build
          # gcov/gcovr 在 ubuntu-latest 上偶发崩溃或返回非 0（例如 gcov returncode -11）。
          # 覆盖率用于报告与产物下载；CI 以“单测通过”为主，因此这里改为 best-effort：
          # - 尝试生成
          # - 失败不阻塞 CI（强制 exit 0）
          # - 确保 ../coverage.xml 一定存在，便于 artifact 下载/截图
          set +e

          GCOVR_WORKERS_FLAG=""
          if gcovr --help 2>/dev/null | grep -q -- '--workers'; then
            GCOVR_WORKERS_FLAG="--workers 1"
          fi

          gcovr -r ../.. --object-directory . \
            --exclude "../../.qtcreator" --exclude "../build" \
            --gcov-executable gcov-12 \
            $GCOVR_WORKERS_FLAG \
            --print-summary --xml-pretty -o ../coverage.xml
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "gcovr failed (exit=$RC). Keeping existing ../coverage.xml as fallback."
          fi

          if [ ! -f ../coverage.xml ]; then
            echo "coverage.xml missing; creating minimal stub.";
            cat > ../coverage.xml <<'XML'
<?xml version="1.0"?>
<coverage line-rate="0" branch-rate="0" version="0" timestamp="0"></coverage>
XML
          fi

          exit 0

      # 5) 上传覆盖率产物（便于下载查看，也方便截图）
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: Lab4/project/tests/coverage.xml
