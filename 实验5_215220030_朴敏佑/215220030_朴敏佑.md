# 实验 5：软件测试与修复 实验报告

## 0. 基本信息

- 学号：`215220030`
- 姓名：`朴敏佑`
- E-mail：`215220030@smail.nju.edu.cn`

### 0.1 测试对象

本次测试对象为个人项目“LedgerApp”（Qt + SQLite），核心逻辑位于 `Lab4/project/database.*`。

### 0.2 测试环境

- 操作系统：Ubuntu 20.04（本实验环境）
- 语言/编译器：C++17，GCC 9.3
- Qt 版本：Qt 5.12.8
- 数据库：SQLite（QtSql 驱动 `QSQLITE`）
- 单元测试框架：QtTest
- 覆盖率工具：gcov/gcovr
- 模糊测试：afl++（含 ASAN/UBSAN）
- 持续集成：GitHub Actions

### 0.3 AI 辅助工具

- 集成式 AI 助手：GitHub Copilot（模型：GPT-5.2）
- 使用场景：缺陷定位、修复方案建议、代码重构与测试用例设计辅助

---

## 1. 单元测试报告

### 1.1 测试目的

- 验证数据库核心逻辑的正确性：账户增删改查/余额更新、交易插入/查询、预算设置/获取、月支出统计等。
- 覆盖边界条件：重复账户名、空查询结果、非法/不存在 ID 删除、跨月时间边界等。

### 1.2 测试工具与测试方法

- 测试框架：QtTest
- 方法：对 `Database` 类方法进行黑盒 + 关键路径白盒结合测试。
- 关键策略：每个测试用例使用临时目录 + 独立 SQLite 文件，保证测试隔离、不污染真实 `ledger.db`。

### 1.3 测试代码位置

- 测试工程：`Lab4/project/tests/LedgerAppTests.pro`
- 测试用例：`Lab4/project/tests/tst_database.cpp`

本次单元测试共 **35 条**测试用例：
- 子功能 A（账户管理与余额更新 + init 边界）：≥10 条
- 子功能 B（交易/分类/预算/统计）：≥10 条
- 集成测试：2 条（见第 2 节）

证据/需提交截图：
- UT-1：单元测试用例代码截图（显示 account_* 与 tx_* 两组用例列表），文件：screenshots/UT-1.png

### 1.4 子功能 A：账户管理与余额更新（10 条）

**测试对象**：`addAccount` / `getAllAccounts` / `updateAccount` / `updateBalance`，以及交易带来的余额变化。

| 用例编号 | 用例名称（对应函数） | 输入/步骤 | 预期输出 | 实际输出 |
|---|---|---|---|---|
| A-01 | account_addAccount_setsId | 新建账户并插入 | 返回 true，id>0 | 通过 |
| A-02 | account_addAccount_duplicateName_fails | 插入同名账户两次 | 第二次插入返回 false | 通过 |
| A-03 | account_getAllAccounts_returnsInserted | 插入两个账户后查询 | 返回数量=2且包含两账户 | 通过 |
| A-04 | account_updateAccount_updatesFields | 更新 name/type/balance | 查询结果字段更新 | 通过 |
| A-05 | account_updateBalance_increases | balance +2.5 | 余额增加 2.5 | 通过 |
| A-06 | account_updateBalance_decreases | balance -3.0 | 余额减少 3.0 | 通过 |
| A-07 | account_updateBalance_nonexistentId_fails | 更新不存在 id | 返回 false（0 行受影响视为失败） | 通过 |
| A-08 | account_balance_matchesAfterTransaction_income | 添加收入交易 | 余额增加 amount | 通过 |
| A-09 | account_balance_matchesAfterTransaction_expense | 添加支出交易 | 余额减少 amount | 通过 |
| A-10 | account_deleteTransaction_revertsBalance | 删除交易 | 余额回滚到删除前 | 通过 |

证据/需提交截图：
- UT-2：QtTest 运行结果截图（显示全部通过），文件：
  - screenshots/UT-2.1.png
  - screenshots/UT-2.2.png
  - screenshots/UT-2.3.png
  -（辅助证据：完整终端输出 screenshots/UT-2_terminal_output.txt）

本次实际运行结果（终端输出保存于 `screenshots/UT-2_terminal_output.txt`）：
- Totals: 35 passed, 0 failed, 0 skipped, 0 blacklisted

### 1.5 子功能 B：交易/预算/支出统计（10 条）

**测试对象**：`addTransaction` / `findTransactions` / `deleteTransaction` / `calculateSpent` / `setBudget` / `getBudget`。

| 用例编号 | 用例名称（对应函数） | 输入/步骤 | 预期输出 | 实际输出 |
|---|---|---|---|---|
| B-01 | tx_addTransaction_setsId | 插入交易 | 返回 true，tx.id>0 | 通过 |
| B-02 | tx_findTransactions_emptyFilter_returnsAll | 插入两条后空过滤查询 | 返回数量=2 | 通过 |
| B-03 | tx_findTransactions_filterByType_incomeOnly | 插入 Income+Expense 后过滤 type | 返回数量=1且 type=Income | 通过 |
| B-04 | tx_findTransactions_filterByAccountId | 两个账户各一条 | 过滤后只返回目标账户记录 | 通过 |
| B-05 | tx_deleteTransaction_nonexistent_fails | 删除不存在的 id | 返回 false | 通过 |
| B-06 | tx_calculateSpent_empty_returns0 | 空库统计 | 返回 0 | 通过 |
| B-07 | tx_calculateSpent_onlyExpenseAndMonthCounted | 2025-12 与 2026-01 混合交易 | 仅统计 202512 的 Expense | 通过 |
| B-08 | budget_setAndGetBudget_roundTrip | setBudget 后 getBudget | limit 保持一致且 id>0 | 通过 |
| B-09 | budget_getBudget_missing_returnsSentinel | 查询缺失预算 | 返回 sentinel（id=-1等） | 通过 |
| B-10 | tx_findTransactions_sortedByTimeDesc | 新旧两条交易 | 返回按时间倒序 | 通过 |

### 1.6 覆盖率说明（单元测试）

本项目选取覆盖率指标：**语句覆盖率（Statement Coverage）**（通过 gcovr 生成）。

- 覆盖率生成位置：本地生成（文件保存于 `screenshots/coverage.xml`，并可在 GitHub Actions 生成 artifact）
- 覆盖率范围：`Lab4/project/database.cpp`（数据库核心逻辑）

本次覆盖率结果（gcovr 输出保存于 `screenshots/COV-1_gcovr_summary.txt`）：
- `database.cpp` 行覆盖率：**85%**（227 / 265）
- 总体行覆盖率：**90%**（623 / 691，lines: 90.2%）

证据/需提交截图：
- COV-1：覆盖率摘要截图，文件：screenshots/COV-1_gcovr_summary.png
-（辅助证据：gcovr 原始输出 screenshots/COV-1_gcovr_summary.txt；覆盖率产物 screenshots/coverage.xml）

### 1.7 单元测试结果分析

- 结果概述：全部通过（35 passed, 0 failed）。
- 关键边界覆盖：重复账户名、删除不存在记录、跨月统计、空库统计。
- 问题与改进：
  - `updateBalance` 对不存在 ID 的更新已修复为返回 false（通过检查 `query.numRowsAffected()`），并补充了对应单元测试。

---

## 2. 集成测试报告

### 2.1 测试目的

验证多个数据库子模块组合后的端到端行为（账户 + 分类 + 交易 + 预算/统计 + 查询）。

### 2.2 测试方法

- 测试方法：自底向上集成
- 说明：在同一临时数据库中按业务流程顺序调用多个方法，验证最终状态。

### 2.3 集成测试用例

测试代码：`Lab4/project/tests/tst_database.cpp`

**用例组 1：预算 vs 支出统计（it_endToEnd_budgetVsSpent）**
- 步骤：添加账户 → 添加支出分类 → 设置预算 → 添加多笔支出交易 → 统计月支出 → 对比预算。
- 预期：spent=交易金额之和；budget.limit >= spent。
- 实际：通过（包含在 QtTest 总计 35 条通过用例中）。

**用例组 2：多账户/多分类查询（it_endToEnd_multiAccountAndCategoryQueries）**
- 步骤：创建 2 个账户与 2 个分类 → 插入收入/支出交易 → 按 type 查询支出 → 按 accountId 查询。
- 预期：支出数量正确；特定账户交易数量正确。
- 实际：通过（包含在 QtTest 总计 35 条通过用例中）。

证据/需提交截图：
- IT-1：集成测试用例代码证据（可直接截图该文件内容）：screenshots/IT-1_code_snippet.txt
- IT-2：集成测试运行结果证据（提取了 it_endToEnd_* 与 Totals 行，可直接截图该文件内容）：screenshots/IT-2_output_extract.txt

### 2.4 集成测试结果分析

- 结果概述：全部通过。
- 发现问题与修复：未发现新的集成缺陷。

---

## 3. 模糊测试报告（afl++）

### 3.1 工具选型与安装

- 工具：afl++
- 运行环境：建议 Linux/WSL(Ubuntu)
- 安装命令（截图证明安装）：

```bash
sudo apt update
sudo apt install -y afl++ clang lld
```

需提交截图：
- FZ-1：安装/版本证明（可直接截图该文件内容）：screenshots/FZ-1_afl_install.txt

### 3.2 使用说明

- fuzz harness：`Lab4/project/fuzz/fuzz_notes_parser.cpp`
- 说明文档：`Lab4/project/fuzz/README_fuzz.md`

编译：

```bash
cd Lab4/project/fuzz
# 为实验快速得到可复现 crash：启用 ENABLE_CRASH_DEMO，并开启 ASAN/UBSAN
AFL_USE_ASAN=1 AFL_USE_UBSAN=1 afl-clang-fast++ -O0 -g -fno-omit-frame-pointer \
  -DENABLE_CRASH_DEMO fuzz_notes_parser.cpp -o fuzz_notes_parser
```

运行：

```bash
mkdir -p in out
printf "LEDG" > in/seed1
printf "BUDGET:100" > in/seed2

# 使用字典提升触发关键路径的概率（包含 "CRASH" / "LEDG" / "BUDGET:"）
AFL_NO_UI=1 afl-fuzz -i in -o out -x notes.dict -m none -- ./fuzz_notes_parser @@
```

需提交截图：
- FZ-2：编译成功证明（可直接截图该文件内容）：screenshots/FZ-2_build_output.txt
- FZ-3：afl-fuzz 运行界面截图（需手动截图终端 UI，见“下一步截图命令”）

### 3.3 崩溃用例收集与复现

crash 是否发现：是。

如果发现 crash：
- crash 样本路径：`Lab4/project/fuzz/out/crashes/id:*`
- 复现命令：

```bash
./fuzz_notes_parser out/crashes/<crash_file>
```

本次实验环境中已保存：
- `screenshots/FZ-4_crashes_ls.txt`：`out/crashes/` 目录列表
- `screenshots/FZ-4_repro_full.txt`：复现输出（ASAN 报告）

证据/需提交截图：
- FZ-4：crashes 目录与复现输出截图，文件：
  - screenshots/FZ-4_crashes_ls.png
  - screenshots/FZ-4_crash_file.png
  - screenshots/FZ-4_repro_full.1.png
  - screenshots/FZ-4_repro_full.2.png
  -（辅助证据：screenshots/FZ-4_crashes_ls.txt、screenshots/FZ-4_crash_file.txt、screenshots/FZ-4_repro_full.txt）

说明：本次已发现 crash，因此“不发现 crash 的 5 小时证明（FZ-5）”不适用。

---

## 4. 持续集成（CI）报告

### 4.1 CI 目标

当代码 push 到 `main` 或发起 PR 时，自动：
- 安装 Qt6（含 QtSql）
- 构建并运行 QtTest
- 生成覆盖率报告并上传为 artifact

### 4.2 工作流文件说明

工作流文件：`.github/workflows/ci.yml`

关键配置说明：
- 触发条件：`push`/`pull_request` 到 `main`
- 主要步骤：checkout → install Qt → install build tools → qmake+make → run tests → gcovr → upload artifact

需提交截图：
- CI-1：工作流文件内容截图（也可直接打开 screenshots/CI-1_ci.yml 截图）
- CI-2：GitHub Actions 全绿运行截图

### 4.3 ci.yml 完整内容（需在报告中给出）

```yaml
name: C++ Qt Project CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1) 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) 安装 Qt6（含 QtTest + QtSql + SQLite 驱动）
      # 说明：aqtinstall 会从官方渠道下载对应的 Qt 组件，适合在 CI 上使用。
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.6.3"
          host: "linux"
          target: "desktop"
          arch: "gcc_64"
          modules: "qtsql"

      # 3) 安装构建工具与覆盖率工具
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y make g++ gcovr

      # 4) 构建并运行单元测试（QtTest）
      - name: Build & run QtTest
        working-directory: Lab4/project/tests
        run: |
          mkdir -p build
          cd build
          qmake "CONFIG+=coverage" ../LedgerAppTests.pro
          make -j2
          QT_QPA_PLATFORM=offscreen ./LedgerAppTests -maxwarnings 0

      # 5) 生成覆盖率报告（基于 gcov）
      - name: Coverage (gcovr)
        working-directory: Lab4/project/tests
        run: |
          cd build
          gcovr -r ../.. --object-directory . \
            --exclude "../../.qtcreator" --exclude "../build" \
            --print-summary --xml-pretty -o ../coverage.xml

      # 6) 上传覆盖率产物（便于下载查看，也方便截图）
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: Lab4/project/tests/coverage.xml
```

---

## 5. 程序修复报告（AI 辅助定位与修复）

### 5.1 缺陷来源与定位

缺陷文件：`Lab4/project/database.cpp`

本次修复至少 3 个缺陷（满足“至少修复 3 个缺陷”的要求），主要来源于单元测试/覆盖率与边界行为检查：
1. `updateBalance` 对不存在账户 ID 仍返回 true（语义错误）
2. `addTransaction` 在余额更新失败时仍可能插入交易（缺少原子性/回滚）
3. `updateTransaction` 未同步调整账户余额（逻辑缺失，且无法处理 type/accountId 变化）

### 5.2 AI 辅助修复过程记录（必须截图）

**提问（Prompts）示例（你可按此复现并截图）：**
- Prompt-1：请根据 `tst_database.cpp` 的失败/边界用例，定位 `database.cpp` 中余额更新与交易更新的逻辑缺陷，并给出最小改动修复方案。
- Prompt-2：如何保证 `addTransaction/deleteTransaction/updateTransaction` 与余额更新原子一致（事务/回滚）？
- Prompt-3：如何把修复点转化为可复现的单元测试用例，并用覆盖率证明关键分支被覆盖？

需提交截图：
- AI-1：Copilot 在 IDE 中可用截图
- AI-2：Prompts 截图
- AI-3：AI 建议截图

### 5.3 修复内容与原理

- 缺陷 1（`updateBalance` 语义错误）：原实现只要 SQL 执行成功就返回 true，即使 0 行受影响。修复为检查 `numRowsAffected()==1`，并新增用例 `account_updateBalance_nonexistentId_fails`。
- 缺陷 2（`addTransaction` 缺少原子性）：原实现先插入 transactions 再更新余额，余额更新失败时会留下“脏交易”。修复为使用数据库事务：插入 + 余额更新任一步失败即 rollback。
- 缺陷 3（`updateTransaction` 不更新余额）：原实现仅更新交易字段，不回滚旧余额也不应用新余额。修复为：读取旧交易 → 更新交易 → 按 delta 差值调整余额（同时支持 type/accountId 变化）→ commit。

需提交截图：
- FIX-1：修复前后对比（`git diff` 或编辑器对比）

本次已生成可直接截图的 diff 证据文件：screenshots/FIX-1_git_diff.txt

### 5.4 修复后验证

- 通过编译：是（QtTest 可正常构建并运行）。
- 相关测试：运行 QtTest（`LedgerAppTests`）。
- 结果：全部通过（35 passed, 0 failed），覆盖率总行覆盖率 90%。

---

## 6. 总结

- 完成内容：单元测试（≥20 条，其中两个子功能各 ≥10 条）、2 组集成测试、模糊测试流程与说明、CI 自动化测试与覆盖率产出、至少 3 个缺陷修复。
- 仍可改进点：
  - 数据库层对非法输入/SQL 注入风险的过滤（`findTransactions(filter)` 直接拼接 SQL 条件）
  - `updateBalance` 已对 0 行受影响返回 false；后续可进一步统一错误返回与 UI 提示

---

## 附录 A：截图清单（交付检查）

已完成并已放入 `screenshots/`：
- UT-1：screenshots/UT-1.png
- UT-2：screenshots/UT-2.1.png、screenshots/UT-2.2.png、screenshots/UT-2.3.png
- IT-1：screenshots/IT-1_code_snippet.txt
- IT-2：screenshots/IT-2_output_extract.txt
- COV-1：screenshots/COV-1_gcovr_summary.png
- FZ-1：screenshots/FZ-1_afl_install.txt
- FZ-2：screenshots/FZ-2_build_output.txt
- FZ-4：screenshots/FZ-4_crashes_ls.png、screenshots/FZ-4_crash_file.png、screenshots/FZ-4_repro_full.1.png、screenshots/FZ-4_repro_full.2.png
- CI-1：screenshots/CI-1_ci.yml
- FIX-1：screenshots/FIX-1_git_diff.txt

仍需补充截图（按课程要求清单）：
- FZ-3（需要 afl-fuzz 终端 UI 截图）
- CI-2（需要 GitHub Actions 网页全绿截图；操作清单已写入 screenshots/CI-2_steps.txt）
- AI-1、AI-2、AI-3（需要 IDE 内 Copilot/对话截图；可直接打开 screenshots/AI-2_prompts.txt 复制 Prompts）
