name: C++ Qt Project CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1) 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) 安装 Qt（使用 Ubuntu APT + Qt5：更稳，避免 Qt6 在 runner 上出现符号不匹配/链接失败）
      # 说明：本项目未依赖 Qt6-only API；Qt5 能满足 QtTest + QtSql(QSQLITE)。
      - name: Install build tools & Qt
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential make gcovr \
            gcc-12 g++-12 \
            qtbase5-dev qtbase5-dev-tools qt5-qmake qtchooser \
            qttools5-dev-tools \
            libqt5sql5-sqlite \
            libgl1-mesa-dev

      # 3) 构建并运行单元测试（QtTest）
      - name: Build & run QtTest
        working-directory: Lab4/project/tests
        run: |
          mkdir -p build
          cd build
          export QT_SELECT=qt5
          echo "Using qmake: $(command -v qmake)"
          qmake "CONFIG+=coverage" "QMAKE_CC=gcc-12" "QMAKE_CXX=g++-12" ../LedgerAppTests.pro
          make -j2
          QT_QPA_PLATFORM=offscreen ./LedgerAppTests -maxwarnings 0

      # 4) 生成覆盖率报告（基于 gcov）
      - name: Coverage (gcovr)
        working-directory: Lab4/project/tests
        run: |
          cd build
          gcovr -r ../.. --object-directory . \
            --exclude "../../.qtcreator" --exclude "../build" \
            --gcov-executable gcov-12 --gcov-parallel 1 \
            --print-summary --xml-pretty -o ../coverage.xml

      # 5) 上传覆盖率产物（便于下载查看，也方便截图）
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: Lab4/project/tests/coverage.xml
